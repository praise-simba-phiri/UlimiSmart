{% extends "base.html" %}
{% load static %}

{% block title %}{% if form.instance.pk %}Edit{% else %}Add{% endif %} Farm{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-8">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
            {% if form.instance.pk %}
            <i class="fas fa-edit mr-2 text-green-600 dark:text-green-400"></i>
            Edit Farm
            {% else %}
            <i class="fas fa-plus mr-2 text-green-600 dark:text-green-400"></i>
            Add New Farm
            {% endif %}
        </h1>
        <p class="text-gray-600 dark:text-gray-400">Manage your farm details</p>
    </div>

    <form method="post" class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md rounded-lg shadow-sm p-6 border border-white/20 dark:border-gray-700/50">
        {% csrf_token %}
        
        <div class="space-y-6">
            <!-- Farm Name -->
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Farm Name</label>
                {{ form.name }}
                {% if form.name.errors %}
                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.name.errors }}</p>
                {% endif %}
            </div>
            
            <!-- District Selection -->
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">District</label>
                {{ form.district }}
                {% if form.district.errors %}
                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.district.errors }}</p>
                {% endif %}
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Coordinates will auto-fill from district</p>
            </div>
            
            <!-- Location Details -->
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Location Details</label>
                {{ form.location }}
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Village or specific area within the district</p>
            </div>
            
            <!-- Coordinates (hidden fields that will be auto-filled) -->
            <input type="hidden" name="latitude" id="id_latitude" value="{{ form.latitude.value|default:'' }}">
            <input type="hidden" name="longitude" id="id_longitude" value="{{ form.longitude.value|default:'' }}">
            
            <!-- Size and Soil Type -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Size (hectares)</label>
                    {{ form.size }}
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Soil Type</label>
                    {{ form.soil_type }}
                </div>
            </div>
            
            <!-- Form Actions -->
            <div class="pt-4 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-3">
                <a href="{% if form.instance.pk %}{% url 'farms:detail' form.instance.pk %}{% else %}{% url 'farms:list' %}{% endif %}" 
                   class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    Cancel
                </a>
                <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    {% if form.instance.pk %}Update{% else %}Create{% endif %} Farm
                </button>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const districtSelect = document.getElementById('id_district');
    const latitudeField = document.getElementById('id_latitude');
    const longitudeField = document.getElementById('id_longitude');
    
    if (districtSelect) {
        districtSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                // Get coordinates from the option's data attributes
                const coords = JSON.parse(selectedOption.dataset.coords || 'null');
                if (coords) {
                    latitudeField.value = coords[0];
                    longitudeField.value = coords[1];
                }
            } else {
                latitudeField.value = '';
                longitudeField.value = '';
            }
        });
        
        // Trigger change event if there's a pre-selected value
        if (districtSelect.value) {
            districtSelect.dispatchEvent(new Event('change'));
        }
    }
});
</script>

<style>
/* Fix for dark mode select dropdown */
select {
    color: #111827; /* gray-900 */
    background-color: #ffffff; /* white */
}

.dark select {
    color: #f3f4f6; /* gray-100 */
    background-color: #1f2937; /* gray-800 */
}

/* Fix for error messages in dark mode */
.text-red-600.dark\:text-red-400 {
    color: #f87171; /* red-400 */
}
</style>
{% endblock %}